"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("@ethersproject/bignumber");function e(){return(e=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(t[s]=r[s])}return t}).apply(this,arguments)}function r(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,i(t,e)}function s(t){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function i(t,e){return(i=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function o(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}function n(t,e,r){return(n=o()?Reflect.construct:function(t,e,r){var s=[null];s.push.apply(s,e);var o=new(Function.bind.apply(t,s));return r&&i(o,r.prototype),o}).apply(null,arguments)}function u(t){var e="function"==typeof Map?new Map:void 0;return(u=function(t){if(null===t||-1===Function.toString.call(t).indexOf("[native code]"))return t;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,r)}function r(){return n(t,arguments,s(this).constructor)}return r.prototype=Object.create(t.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),i(r,t)})(t)}var a=!1;function c(t){a&&t()}function h(t,e,r){return 0===r?t===e:t<1/r?Math.abs(t-e)<=10:Math.abs(t/e-1)<r}function p(t,e,r){void 0===r&&(r=1);try{if(e<=t(0))return 0;var s,i;if(t(r)>e){for(s=r/2;t(s)>e;)s/=2;i=2*s}else{for(i=2*r;t(i)<e;)i*=2;s=i/2}for(;i/s-1>1e-4;){var o=(s+i)/2,n=t(o);if(e===n)return o;e<n?i=o:s=o}return(s+i)/2}catch(t){return 0}}function v(e){var r=Math.abs(e);if(r<Number.MAX_SAFE_INTEGER)return t.BigNumber.from(Math.round(e));var s=Math.floor(Math.log(r)/Math.LN2);console.assert(s>=51,"Internal Error 314");var i=s-51,o=Math.round(r/Math.pow(2,i)),n=t.BigNumber.from(o).mul(t.BigNumber.from(2).pow(i));return e>0?n:n.mul(-1)}var l,d=function(){function t(t,e,r,s,i,o,n,u){void 0===n&&(n=1e3),void 0===u&&(u=6e4),this.address=t,this.token0=e,this.token1=r,this.fee=s,this.minLiquidity=n,this.swapGasCost=u,this.reserve0=i,this.reserve1=o}return t.prototype.updateReserves=function(t,e){this.reserve0=t,this.reserve1=e},t}(),f=function(t){function e(e,r,s,i,o,n){var u;return(u=t.call(this,e,r,s,i,o,n)||this).reserve0Number=parseInt(o.toString()),u.reserve1Number=parseInt(n.toString()),u}r(e,t);var s=e.prototype;return s.updateReserves=function(t,e){this.reserve0=t,this.reserve0Number=parseInt(t.toString()),this.reserve1=e,this.reserve1Number=parseInt(e.toString())},s.calcOutByIn=function(t,e){return{out:(e?this.reserve1Number:this.reserve0Number)*t/((e?this.reserve0Number:this.reserve1Number)/(1-this.fee)+t),gasSpent:this.swapGasCost}},s.calcInByOut=function(t,e){var r=e?this.reserve1Number:this.reserve0Number;return r-t<this.minLiquidity?{inp:Number.POSITIVE_INFINITY,gasSpent:this.swapGasCost}:{inp:(e?this.reserve0Number:this.reserve1Number)*t/(1-this.fee)/(r-t),gasSpent:this.swapGasCost}},s.calcCurrentPriceWithoutFee=function(t){return this.calcPrice(0,t,!1)},s.calcPrice=function(t,e,r){var s=(e?this.reserve0Number:this.reserve1Number)/(r?1-this.fee:1);return(e?this.reserve1Number:this.reserve0Number)*s/(s+t)/(s+t)},s.calcInputByPrice=function(t,e,r){var s=(e?this.reserve0Number:this.reserve1Number)/(r?1-this.fee:1);return Math.sqrt((e?this.reserve1Number:this.reserve0Number)*s*t)-s},s.getLiquidity=function(){return Math.sqrt(this.reserve0Number*this.reserve1Number)},e}(d),g=function(e){function s(r,s,i,o,n,u,a){var c;return(c=e.call(this,r,s,i,o,u,a)||this).A_PRECISION=100,c.A=n,c.D=t.BigNumber.from(0),c}r(s,e);var i=s.prototype;return i.updateReserves=function(e,r){this.D=t.BigNumber.from(0),this.reserve0=e,this.reserve1=r},i.computeLiquidity=function(){if(!this.D.eq(0))return this.D;var e=this.reserve0,r=this.reserve1;if(e.isZero()&&r.isZero())return t.BigNumber.from(0);for(var s,i=e.add(r),o=t.BigNumber.from(2*this.A),n=i,u=0;u<256;u++){var a=n.mul(n).div(e).mul(n).div(r).div(4);if(s=n,(n=o.mul(i).div(this.A_PRECISION).add(a.mul(2)).mul(n).div(o.div(this.A_PRECISION).sub(1).mul(n).add(a.mul(3)))).sub(s).abs().lte(1))break}return this.D=n,n},i.computeY=function(t){for(var e,r=this.computeLiquidity(),s=2*this.A,i=r.mul(r).div(t.mul(2)).mul(r).div(2*s/this.A_PRECISION),o=r.mul(this.A_PRECISION).div(s).add(t),n=r,u=0;u<256&&(e=n,!(n=n.mul(n).add(i).div(n.mul(2).add(o).sub(r))).sub(e).abs().lte(1));u++);return n},i.calcOutByIn=function(t,e){var r=e?this.reserve1:this.reserve0,s=(e?this.reserve0:this.reserve1).add(v(t*(1-this.fee))),i=this.computeY(s);return{out:parseInt(r.sub(i).toString()),gasSpent:this.swapGasCost}},i.calcInByOut=function(e,r){var s=r?this.reserve0:this.reserve1,i=(r?this.reserve1:this.reserve0).sub(v(e));i.lt(1)&&(i=t.BigNumber.from(1));var o=this.computeY(i);return{inp:Math.round(parseInt(o.sub(s).toString())/(1-this.fee)),gasSpent:this.swapGasCost}},i.calcCurrentPriceWithoutFee=function(t){return this.calcPrice(0,t,!1)},i.calcPrice=function(t,e,r){var s=parseInt((e?this.reserve0:this.reserve1).toString()),i=r?1-this.fee:1,o=parseInt(this.computeLiquidity().toString()),n=this.A/this.A_PRECISION,u=s+t,a=4*n*u+o-4*n*o,c=o*o*o/u;return(.5-(2*a-c/u)/Math.sqrt(a*a+4*n*c)/4)*i},i.calcInputByPrice=function(t,e,r,s){var i=this;return void 0===s&&(s=1),p((function(t){return 1/i.calcPrice(t,e,r)}),t,s)},s}(d),m=function(t){function e(e,r,s,i,o,n,u,a,c,h,p){var v;return(v=t.call(this,e,r,s,i,n,u,1e3,6e4)||this).tickSpacing=o,v.liquidity=a,v.sqrtPrice=c,v.nearestTick=h,v.ticks=p,0===v.ticks.length&&(v.ticks.push({index:-887272,DLiquidity:0}),v.ticks.push({index:887271,DLiquidity:0})),v.ticks[0].index>-887272&&v.ticks.unshift({index:-887272,DLiquidity:0}),v.ticks[v.ticks.length-1].index<887271&&v.ticks.push({index:887271,DLiquidity:0}),v}r(e,t);var s=e.prototype;return s.calcOutByIn=function(t,e){for(var r=e?this.nearestTick:this.nearestTick+1,s=this.sqrtPrice,i=this.liquidity,o=0,n=t;n>0;){if(r<0||r>=this.ticks.length)return{out:o,gasSpent:this.swapGasCost};var u=Math.sqrt(Math.pow(1.0001,this.ticks[r].index)),a=0;if(e){var c=i*(s-u)/s/u;n<=c?(a=i*s*n/(n+i/s),n=0):(a=i*(s-u),s=u,n-=c,this.ticks[r].index/this.tickSpacing%2==0?i-=this.ticks[r].DLiquidity:i+=this.ticks[r].DLiquidity,r--)}else{var h=i*(u-s);n<=h?(a=n/s/(s+n/i),n=0):(a=i*(u-s)/s/u,s=u,n-=h,this.ticks[r].index/this.tickSpacing%2==0?i+=this.ticks[r].DLiquidity:i-=this.ticks[r].DLiquidity,r++)}o+=a*(1-this.fee)}return{out:o,gasSpent:this.swapGasCost}},s.calcInByOut=function(t,e){for(var r=e?this.nearestTick:this.nearestTick+1,s=this.sqrtPrice,i=this.liquidity,o=0,n=t/(1-this.fee);n>0;){if(r<0||r>=this.ticks.length)return{inp:o,gasSpent:this.swapGasCost};var u=Math.sqrt(Math.pow(1.0001,this.ticks[r].index));if(e){var a=i*(s-u);n<=a?(o+=n/s/(s-n/i),n=0):(o+=i*(s-u)/s/u,s=u,n-=a,this.ticks[r].index/this.tickSpacing%2==0?i-=this.ticks[r].DLiquidity:i+=this.ticks[r].DLiquidity,r--)}else{var c=i*(u-s)/s/u;n<=c?(o+=i*s*n/(i/s-n),n=0):(o+=i*(u-s),s=u,n-=c,this.ticks[r].index/this.tickSpacing%2==0?i+=this.ticks[r].DLiquidity:i-=this.ticks[r].DLiquidity,r++)}}return{inp:o,gasSpent:this.swapGasCost}},s.calcCurrentPriceWithoutFee=function(t){var e=this.sqrtPrice*this.sqrtPrice;return t?e:1/e},e}(d),I=function(e){function s(r,s,i,o,n,u){var a;return(a=e.call(this,r,s,i,o,n,u)||this).k=t.BigNumber.from(0),a}r(s,e);var i=s.prototype;return i.updateReserves=function(e,r){this.k=t.BigNumber.from(0),this.reserve0=e,this.reserve1=r},i.computeK=function(){if(this.k.isZero()){var t=this.reserve0,e=this.reserve1;this.k=t.mul(e).mul(t.mul(t).add(e.mul(e)))}return this.k},i.computeY=function(t,e){for(var r=this.computeK(),s=t.shl(1),i=t.mul(3),o=t.mul(t).mul(t),n=e,u=e,a=0;a<255;++a){var c=u.mul(u);if((u=c.mul(u).mul(s).add(r).div(c.mul(i).add(o))).sub(n).abs().lte(1))break;n=u}return u},i.calcOutByIn=function(t,e){var r=e?this.reserve1:this.reserve0,s=(e?this.reserve0:this.reserve1).add(v(Math.floor(t*(1-this.fee)))),i=this.computeY(s,r),o=parseInt(r.sub(i).toString())-1;return{out:Math.max(o,0),gasSpent:this.swapGasCost}},i.calcInByOut=function(t,e){var r=e?this.reserve0:this.reserve1,s=(e?this.reserve1:this.reserve0).sub(v(Math.ceil(t)));if(s.lt(this.minLiquidity))return{inp:Number.POSITIVE_INFINITY,gasSpent:this.swapGasCost};var i=this.computeY(s,r);return{inp:Math.round(parseInt(i.sub(r).toString())/(1-this.fee))+1,gasSpent:this.swapGasCost}},i.calcCurrentPriceWithoutFee=function(t){var e=this.reserve0.gt(this.reserve1),r=parseInt((e?this.reserve0:this.reserve1).toString()),s=parseInt(this.computeK().toString())/r/2,i=-s/r,o=Math.pow(r,6)/27+s*s,n=6*Math.pow(r,5)/27+2*s*i,u=Math.sqrt(o),a=.5/u*n,c=u+s,h=a+i,p=u-s,v=a-i,l=1/3*Math.pow(c,1/3)/c*h-1/3*Math.pow(p,1/3)/p*v;return e==t?-l:-1/l},s}(d);(l=exports.RouteStatus||(exports.RouteStatus={})).Success="Success",l.NoWay="NoWay",l.Partial="Partial";var P,b=function(){function t(t,e,r){this.pool=t,this.vert0=e,this.vert1=r,this.amountInPrevious=0,this.amountOutPrevious=0,this.canBeUsed=!0,this.direction=!0,this.spentGas=0,this.spentGasNew=0,this.bestEdgeIncome=0}var e=t.prototype;return e.cleanTmpData=function(){this.amountInPrevious=0,this.amountOutPrevious=0,this.canBeUsed=!0,this.direction=!0,this.spentGas=0,this.spentGasNew=0,this.bestEdgeIncome=0},e.reserve=function(t){return t===this.vert0?this.pool.reserve0:this.pool.reserve1},e.calcOutput=function(t,e){var r,s;if(t===this.vert1)if(this.direction)if(e<this.amountOutPrevious){var i=this.pool.calcInByOut(this.amountOutPrevious-e,!0);r=this.amountInPrevious-i.inp,s=i.gasSpent}else{var o=this.pool.calcOutByIn(e-this.amountOutPrevious,!1);r=o.out+this.amountInPrevious,s=o.gasSpent}else{var n=this.pool.calcOutByIn(this.amountOutPrevious+e,!1);r=n.out-this.amountInPrevious,s=n.gasSpent}else if(this.direction){var u=this.pool.calcOutByIn(this.amountInPrevious+e,!0);r=u.out-this.amountOutPrevious,s=u.gasSpent}else if(e<this.amountInPrevious){var a=this.pool.calcInByOut(this.amountInPrevious-e,!1);r=this.amountOutPrevious-a.inp,s=a.gasSpent}else{var c=this.pool.calcOutByIn(e-this.amountInPrevious,!0);r=c.out+this.amountOutPrevious,s=c.gasSpent}return{out:r,gasSpent:s-this.spentGas}},e.calcInput=function(t,e){var r,s;if(t===this.vert1)if(this.direction){var i=this.pool.calcInByOut(this.amountOutPrevious+e,!0);r=i.inp-this.amountInPrevious,s=i.gasSpent}else if(e<this.amountOutPrevious){var o=this.pool.calcOutByIn(this.amountOutPrevious-e,!1);r=this.amountInPrevious-o.out,s=o.gasSpent}else{var n=this.pool.calcInByOut(e-this.amountOutPrevious,!0);r=n.inp+this.amountInPrevious,s=n.gasSpent}else if(this.direction)if(e<this.amountInPrevious){var u=this.pool.calcOutByIn(this.amountInPrevious-e,!0);r=this.amountOutPrevious-u.out,s=u.gasSpent}else{var a=this.pool.calcInByOut(e-this.amountInPrevious,!1);r=a.inp+this.amountOutPrevious,s=a.gasSpent}else{var c=this.pool.calcInByOut(this.amountInPrevious+e,!1);r=c.inp-this.amountOutPrevious,s=c.gasSpent}return{inp:r,gasSpent:s-this.spentGas}},e.checkMinimalLiquidityExceededAfterSwap=function(t,e){if(t===this.vert0){var r=parseInt(this.pool.reserve1.toString());return this.direction?r-e-this.amountOutPrevious<this.pool.minLiquidity:r-e+this.amountOutPrevious<this.pool.minLiquidity}var s=parseInt(this.pool.reserve0.toString());return this.direction?s-e+this.amountInPrevious<this.pool.minLiquidity:s-e-this.amountInPrevious<this.pool.minLiquidity},e.testApply=function(t,e,r){console.assert(this.amountInPrevious*this.amountOutPrevious>=0);var s,i=this.direction?this.amountInPrevious:-this.amountInPrevious,o=this.direction?this.amountOutPrevious:-this.amountOutPrevious,n=0,u=0;if(t.getNeibour(this)){var a=i+(t===this.vert0?e:-r),c=o+(t===this.vert0?r:-e);a*c<0&&console.log("333"),console.assert(a*c>=0),a>=0?(s=!0,n=a,u=c):(s=!1,n=-a,u=-c)}else console.error("Error 221");if(s){var p=this.pool.calcOutByIn(n,!0).out,v=h(u,p,1e-6);return v||console.log("Err 225-1 !!",u,p,Math.abs(p/u-1)),v}var l=this.pool.calcOutByIn(u,!1).out,d=h(n,l,1e-6);return d||console.log("Err 225-2!!",n,l,Math.abs(l/n-1)),d},e.applySwap=function(t){console.assert(this.amountInPrevious*this.amountOutPrevious>=0);var e=this.direction?this.amountInPrevious:-this.amountInPrevious,r=this.direction?this.amountOutPrevious:-this.amountOutPrevious,s=t.getNeibour(this);if(s){var i=e+(t===this.vert0?t.bestIncome:-s.bestIncome),o=r+(t===this.vert0?s.bestIncome:-t.bestIncome);console.assert(i*o>=0),i>=0?(this.direction=!0,this.amountInPrevious=i,this.amountOutPrevious=o):(this.direction=!1,this.amountInPrevious=-i,this.amountOutPrevious=-o)}else console.error("Error 221");this.spentGas=this.spentGasNew},t}(),y=function(){function t(t){this.token=t,this.edges=[],this.price=0,this.gasPrice=0,this.bestIncome=0,this.gasSpent=0,this.bestTotal=0,this.bestSource=void 0,this.checkLine=-1}var e=t.prototype;return e.cleanTmpData=function(){this.bestIncome=0,this.gasSpent=0,this.bestTotal=0,this.bestSource=void 0,this.checkLine=-1},e.getNeibour=function(t){if(t)return t.vert0===this?t.vert1:t.vert0},e.getOutputEdges=function(){var t=this;return this.edges.filter((function(e){return!!e.canBeUsed&&0!==e.amountInPrevious&&e.direction===(e.vert0===t)}))},e.getInputEdges=function(){var t=this;return this.edges.filter((function(e){return!!e.canBeUsed&&0!==e.amountInPrevious&&e.direction!==(e.vert0===t)}))},t}(),S=function(){function e(t,e,r){var s=this;this.vertices=[],this.edges=[],this.tokens=new Map,t.forEach((function(t){var e=s.getOrCreateVertice(t.token0),r=s.getOrCreateVertice(t.token1),i=new b(t,e,r);e.edges.push(i),r.edges.push(i),s.edges.push(i)}));var i=this.tokens.get(e.address);i&&this.setPricesStable(i,1,r)}var r=e.prototype;return r.cleanTmpData=function(){this.edges.forEach((function(t){return t.cleanTmpData()})),this.vertices.forEach((function(t){return t.cleanTmpData()}))},r.setPricesStable=function(t,e,r){this.vertices.forEach((function(t){return t.price=0})),t.price=e,t.gasPrice=r;var s=new Map,i=function(t){return s.get(t)};function o(t){var e=t.edges.filter((function(e){var r;return 0==(null==(r=t.getNeibour(e))?void 0:r.price)}));e.forEach((function(e){return s.set(e,t.price*parseInt(e.reserve(t).toString()))})),e.sort((function(t,e){return i(t)-i(e)}));for(var r=[];n.length&&e.length;)i(n[0])<i(e[0])?r.push(n.shift()):r.push(e.shift());n=[].concat(r,n,e)}var n=[];for(o(t);n.length>0;){var u=n.pop(),a=0!==u.vert1.price?[u.vert1,u.vert0]:[u.vert0,u.vert1],c=a[0],h=a[1];if(0===h.price){var p=u.pool.calcCurrentPriceWithoutFee(c===u.vert1);h.price=c.price*p,h.gasPrice=c.gasPrice/p,o(h)}}},r.setPrices=function(t,e,r){var s=this;0===t.price&&(t.price=e,t.gasPrice=r,t.edges.map((function(e){return[e,parseInt(e.reserve(t).toString())]})).sort((function(t,e){return e[1]-t[1]})).forEach((function(i){var o=i[0],n=o.vert0===t?o.vert1:o.vert0;if(0===n.price){var u=o.pool.calcCurrentPriceWithoutFee(t===o.vert1);s.setPrices(n,e*u,r/u)}})))},r.getOrCreateVertice=function(t){var e=this.tokens.get(t.address);return e||(e=new y(t),this.vertices.push(e),this.tokens.set(t.address,e),e)},r.findBestPathExactIn=function(t,e,r,s){var i=this.tokens.get(t.address),o=this.tokens.get(e.address);if(i&&o){var n=void 0!==s?s:o.gasPrice;this.edges.forEach((function(t){t.bestEdgeIncome=0,t.spentGasNew=0})),this.vertices.forEach((function(t){t.bestIncome=0,t.gasSpent=0,t.bestTotal=0,t.bestSource=void 0,t.checkLine=-1})),i.bestIncome=r,i.bestTotal=r;for(var u=new Set,a=[i],h="",p=0,v=function(){var r=void 0,s=void 0,i=0;if(a.forEach((function(t,e){(void 0===s||t.bestTotal>s)&&(s=t.bestTotal,r=t,i=e)})),!r)return{v:void 0};if(r.checkLine=p++,r===o){for(var v=[],l=o;null!=(d=l)&&d.bestSource;l=l.getNeibour(l.bestSource)){var d;v.unshift(l.bestSource)}return c((function(){return console.log(h)})),{v:{path:v,output:o.bestIncome,gasSpent:o.gasSpent,totalOutput:o.bestTotal}}}a.splice(i,1),r.edges.forEach((function(s){var i=r===s.vert0?s.vert1:s.vert0;if(!u.has(i)){var p,v;try{var l=s.calcOutput(r,r.bestIncome),d=l.out,f=l.gasSpent;if(!isFinite(d)||!isFinite(f))return;p=d,v=f}catch(s){return}if(s.checkMinimalLiquidityExceededAfterSwap(r,p))s.bestEdgeIncome=-1;else{var g=r.gasSpent+v,m=i.price/o.price,I=p*m-g*n;console.assert(0===s.bestEdgeIncome,"Error 373"),s.bestEdgeIncome=p*m,s.spentGasNew=s.spentGas+v,i.bestSource||a.push(i),(!i.bestSource||I>i.bestTotal)&&(c((function(){var s,o,n=(null==(s=r)?void 0:s.token)==t?"*":"";h+=""+n+(null==(o=r)?void 0:o.token.name)+"->"+i.token.name+((null==i?void 0:i.token)==e?"*":"")+" "+i.bestIncome+" -> "+p+"\n"})),i.bestIncome=p,i.gasSpent=g,i.bestTotal=I,i.bestSource=s)}}})),u.add(r)};;){var l=v();if("object"==typeof l)return l.v}}},r.findBestPathExactOut=function(t,e,r,s){var i=this.tokens.get(e.address),o=this.tokens.get(t.address);if(i&&o){var n=void 0!==s?s:o.gasPrice;this.edges.forEach((function(t){t.bestEdgeIncome=0,t.spentGasNew=0})),this.vertices.forEach((function(t){t.bestIncome=0,t.gasSpent=0,t.bestTotal=0,t.bestSource=void 0,t.checkLine=-1})),i.bestIncome=r,i.bestTotal=r;for(var u=new Set,a=[i],h="",p=0,v=function(){var r=void 0,s=void 0,i=0;if(a.forEach((function(t,e){(void 0===s||t.bestTotal<s)&&(s=t.bestTotal,r=t,i=e)})),!r)return{v:void 0};if(r.checkLine=p++,r===o){for(var v=[],l=o;null!=(d=l)&&d.bestSource;l=l.getNeibour(l.bestSource)){var d;v.push(l.bestSource)}return c((function(){return console.log(h)})),{v:{path:v,input:o.bestIncome,gasSpent:o.gasSpent,totalInput:o.bestTotal}}}a.splice(i,1),r.edges.forEach((function(s){var i=r===s.vert0?s.vert1:s.vert0;if(!u.has(i)){var p,v;try{var l=s.calcInput(r,r.bestIncome),d=l.inp,f=l.gasSpent;if(!isFinite(d)||!isFinite(f))return;if(d<0)return;p=d,v=f}catch(s){return}var g=r.gasSpent+v,m=i.price/o.price,I=p*m+g*n;console.assert(0===s.bestEdgeIncome,"Error 373"),s.bestEdgeIncome=p*m,s.spentGasNew=s.spentGas+v,i.bestSource||a.push(i),(!i.bestSource||I<i.bestTotal)&&(c((function(){var s,o,n=(null==(s=r)?void 0:s.token)==e?"*":"";h+=((null==i?void 0:i.token)==t?"*":"")+(null==(o=r)?void 0:o.token.name)+"<-"+i.token.name+n+" "+i.bestIncome+" -> "+p+"\n"})),i.bestIncome=p,i.gasSpent=g,i.bestTotal=I,i.bestSource=s)}})),u.add(r)};;){var l=v();if("object"==typeof l)return l.v}}},r.addPath=function(t,e,r){var s=t;r.forEach((function(t){s?(t.applySwap(s),s=s.getNeibour(t)):console.error("Unexpected 315")}))},r.getPrimaryPriceForPath=function(t,e){var r=1,s=t;return e.forEach((function(t){var e=t.pool.calcCurrentPriceWithoutFee(t.vert0===s);r*=e,s=s.getNeibour(t)})),r},r.findBestRouteExactIn=function(e,r,s,i){var o=[];if(Array.isArray(i)){var n=i.reduce((function(t,e){return t+e}),0);o=i.map((function(t){return t/n}))}else for(var u=0;u<i;++u)o.push(1/i);this.edges.forEach((function(t){t.amountInPrevious=0,t.amountOutPrevious=0,t.direction=!0}));var a,c,h,p=0,l=0,d=0;for(c=0;c<o.length;++c){var f=this.findBestPathExactIn(e,r,s*o[c]);if(!f)break;p+=f.output,l+=f.gasSpent,this.addPath(this.tokens.get(e.address),this.tokens.get(r.address),f.path),d+=o[c],0===c&&(a=this.getPrimaryPriceForPath(this.tokens.get(e.address),f.path))}if(0==c)return{status:exports.RouteStatus.NoWay,fromToken:e,toToken:r,amountIn:0,amountInBN:t.BigNumber.from(0),amountOut:0,amountOutBN:t.BigNumber.from(0),legs:[],gasSpent:0,totalAmountOut:0,totalAmountOutBN:t.BigNumber.from(0)};h=c<o.length?exports.RouteStatus.Partial:exports.RouteStatus.Success;var g,m,I=this.tokens.get(e.address),P=this.tokens.get(r.address),b=this.getRouteLegs(I,P),y=b.legs,S=b.gasSpent,k=b.topologyWasChanged;console.assert(S<=l,"Internal Error 491"),k&&(p=this.calcLegsAmountOut(y,s));try{g=p/s,m=void 0!==a?1-g/a:void 0}catch(t){}return{status:h,fromToken:e,toToken:r,primaryPrice:a,swapPrice:g,priceImpact:m,amountIn:s*d,amountInBN:v(s*d),amountOut:p,amountOutBN:v(p),legs:y,gasSpent:S,totalAmountOut:p-S*P.gasPrice,totalAmountOutBN:v(p-S*P.gasPrice)}},r.findBestRouteExactOut=function(e,r,s,i){var o=[];if(Array.isArray(i)){var n=i.reduce((function(t,e){return t+e}),0);o=i.map((function(t){return t/n}))}else for(var u=0;u<i;++u)o.push(1/i);this.edges.forEach((function(t){t.amountInPrevious=0,t.amountOutPrevious=0,t.direction=!0}));var a,c,h,p=0,l=0,d=0;for(c=0;c<o.length;++c){var f=this.findBestPathExactOut(e,r,s*o[c]);if(!f)break;p+=f.input,l+=f.gasSpent,this.addPath(this.tokens.get(e.address),this.tokens.get(r.address),f.path),d+=o[c],0===c&&(a=this.getPrimaryPriceForPath(this.tokens.get(e.address),f.path))}if(0==c)return{status:exports.RouteStatus.NoWay,fromToken:e,toToken:r,amountIn:0,amountInBN:t.BigNumber.from(0),amountOut:0,amountOutBN:t.BigNumber.from(0),legs:[],gasSpent:0,totalAmountOut:0,totalAmountOutBN:t.BigNumber.from(0)};h=c<o.length?exports.RouteStatus.Partial:exports.RouteStatus.Success;var g,m,I=this.tokens.get(e.address),P=this.tokens.get(r.address),b=this.getRouteLegs(I,P),y=b.legs,S=b.gasSpent,k=b.topologyWasChanged;console.assert(S<=l,"Internal Error 491"),k&&(p=this.calcLegsAmountIn(y,s));try{g=s/p,m=void 0!==a?1-g/a:void 0}catch(t){}return{status:h,fromToken:e,toToken:r,primaryPrice:a,swapPrice:g,priceImpact:m,amountIn:p,amountInBN:v(p),amountOut:s*d,amountOutBN:v(s*d),legs:y,gasSpent:S,totalAmountOut:s-S*P.gasPrice,totalAmountOutBN:v(s-S*P.gasPrice)}},r.getRouteLegs=function(t,e){var r=this,s=this.cleanTopology(t,e),i=s.topologyWasChanged,o=[],n=0;return s.vertices.forEach((function(t){var e=t.getOutputEdges().map((function(t){var e=r.edgeFrom(t);return e?[t,e.vert,e.amount]:[t]})),s=e.reduce((function(t,e){return t+e[2]}),0);if(!(s<=0)){var i=s;e.forEach((function(r,u){var a=r[2],c=u+1===e.length?1:a/s,h=r[0];o.push({poolAddress:h.pool.address,poolFee:h.pool.fee,tokenFrom:t.token,tokenTo:t.getNeibour(h).token,assumedAmountIn:h.direction?h.amountInPrevious:h.amountOutPrevious,assumedAmountOut:h.direction?h.amountOutPrevious:h.amountInPrevious,swapPortion:c,absolutePortion:a/i}),n+=r[0].pool.swapGasCost,s-=a})),console.assert(s/i<1e-12,"Error 281")}})),{legs:o,gasSpent:n,topologyWasChanged:i}},r.edgeFrom=function(t){if(0!==t.amountInPrevious)return t.direction?{vert:t.vert0,amount:t.amountInPrevious}:{vert:t.vert1,amount:t.amountOutPrevious}},r.calcLegsAmountOut=function(t,e){var r=this,s=new Map;return s.set(t[0].tokenFrom.address,e),t.forEach((function(t){var e=r.tokens.get(t.tokenFrom.address);console.assert(void 0!==e,"Internal Error 570");var i=e.edges.find((function(e){return e.pool.address===t.poolAddress}));console.assert(void 0!==i,"Internel Error 569");var o=i.pool,n=e===i.vert0,u=s.get(t.tokenFrom.address);console.assert(void 0!==u,"Internal Error 564");var a=u*t.swapPortion;s.set(t.tokenFrom.address,u-a);var c=o.calcOutByIn(a,n).out,h=e.getNeibour(i),p=s.get(h.token.address);s.set(h.token.address,(p||0)+c)})),s.get(t[t.length-1].tokenTo.address)||0},r.calcLegsAmountIn=function(t,e){var r=this,s=new Map;t.forEach((function(t){var e=s.get(t.tokenFrom.address)||0;s.set(t.tokenFrom.address,e+t.assumedAmountOut)}));var i=new Map;i.set(t[t.length-1].tokenTo.address,e);for(var o=function(e){var o=t[e],n=r.tokens.get(o.tokenTo.address);console.assert(void 0!==n,"Internal Error 884");var u=n.edges.find((function(t){return t.pool.address===o.poolAddress}));console.assert(void 0!==u,"Internel Error 888");var a=u.pool,c=n===u.vert1,h=i.get(o.tokenTo.address);console.assert(void 0!==h,"Internal Error 893");var p=s.get(o.tokenFrom.address);console.assert(void 0!==p,"Internal Error 903");var v=a.calcInByOut(h*o.assumedAmountOut/p,c).inp,l=n.getNeibour(u),d=i.get(l.token.address);i.set(l.token.address,(d||0)+v)},n=t.length-1;n>=0;--n)o(n);return i.get(t[0].tokenFrom.address)||0},r.cleanTopology=function(t,e){var r=!1,s=this.topologySort(t,e);if(2!==s.status){for(r=!0,console.assert(0===s.status,"Internal Error 554");0===s.status;)this.removeWeakestEdge(s.vertices),s=this.topologySort(t,e);if(3===s.status&&(this.removeDeadEnds(s.vertices),s=this.topologySort(t,e)),console.assert(2===s.status,"Internal Error 563"),2!==s.status)return{vertices:[],topologyWasChanged:r}}return{vertices:s.vertices,topologyWasChanged:r}},r.removeDeadEnds=function(t){t.forEach((function(t){t.getInputEdges().forEach((function(t){t.canBeUsed=!1}))}))},r.removeWeakestEdge=function(t){var e,r,s=Number.MAX_VALUE;t.forEach((function(i,o){var n=0===o?t[t.length-1]:t[o-1],u=0;i.getOutputEdges().forEach((function(t){i.getNeibour(t)===n&&(u+=t.direction?t.amountOutPrevious:t.amountInPrevious)})),u<s&&(e=i,r=n,s=u)})),e.getOutputEdges().forEach((function(t){e.getNeibour(t)===r&&(t.canBeUsed=!1)}))},r.topologySort=function(t,e){var r=new Map,s=[],i=[],o=[],n=function t(n){var u=r.get(n);if(2===u||3===u)return u;if(1===u)return console.assert(0==i.length,"Internal Error 566"),i.push(n),1;r.set(n,1);for(var a=!1,c=n.getOutputEdges(),h=0;h<c.length;++h){var p=t(n.getNeibour(c[h]));if(0===p)return 0;if(1===p)return i[0]===n?0:(i.push(n),1);2===p&&(a=!0)}return a?(console.assert(n!==e,"Internal Error 589"),s.push(n),r.set(n,2),2):n!==e?(o.push(n),r.set(n,3),3):(s.push(n),r.set(n,2),2)}(t);return 0===n?{status:0,vertices:i}:o.length?{status:3,vertices:o}:2===n?{status:2,vertices:s.reverse()}:(console.assert(!0,"Internal Error 612"),{status:1,vertices:[]})},e}();function k(t,e,r){var s=function(t){if(void 0!==t.primaryPrice&&void 0!==t.swapPrice){var e=1;return t.legs.forEach((function(t){return e*=1-t.poolFee})),Math.max(0,1-t.swapPrice/t.primaryPrice/e)}}(t);if(!s)return 12;var i=Math.sqrt(t.gasSpent*(r||0)*e/s),o=Math.round(e/i);return isFinite(o)?Math.max(1,Math.min(o,100)):100}(P=exports.PoolType||(exports.PoolType={})).ConstantProduct="ConstantProduct",P.Weighted="Weighted",P.Hybrid="Hybrid",P.ConcentratedLiquidity="ConcentratedLiquidity";var O=function(t){var r=e({minLiquidity:1e3,swapGasCost:4e4},t);this.address=r.address,this.token0=r.token0,this.token1=r.token1,this.type=r.type,this.reserve0=r.reserve0,this.reserve1=r.reserve1,this.fee=r.fee,this.minLiquidity=r.minLiquidity,this.swapGasCost=r.swapGasCost},x=function(t){function s(r){return t.call(this,e({type:exports.PoolType.ConstantProduct},r))||this}return r(s,t),s}(O),E=function(t){function s(r){var s;return(s=t.call(this,e({type:exports.PoolType.Hybrid},r))||this).A=r.A,s}return r(s,t),s}(O),N=function(t){function s(r){var s;return(s=t.call(this,e({type:exports.PoolType.Weighted},r))||this).weight0=r.weight0,s.weight1=r.weight1,s}return r(s,t),s}(O),w=function(s){function i(r){var i;return(i=s.call(this,e({type:exports.PoolType.ConcentratedLiquidity,reserve0:t.BigNumber.from(0),reserve1:t.BigNumber.from(0)},r))||this).liquidity=r.liquidity,i.sqrtPrice=r.sqrtPrice,i.nearestTick=r.nearestTick,i.ticks=r.ticks,i}return r(i,s),i}(O),B=new Map;function T(e){var r=B.get(e);if(void 0!==r)return r;var s=e.reserve0,i=e.reserve1;if(s.isZero()&&i.isZero())return B.set(e,t.BigNumber.from(0)),t.BigNumber.from(0);for(var o,n=s.add(i),u=t.BigNumber.from(2*e.A),a=n,c=0;c<256;c++){var h=a.mul(a).div(s).mul(a).div(i).div(4);if(o=a,(a=u.mul(n).div(100).add(h.mul(2)).mul(a).div(u.div(100).sub(1).mul(a).add(h.mul(3)))).sub(o).abs().lte(1))break}return B.set(e,a),a}function M(t,e){for(var r,s=T(t),i=2*t.A,o=s.mul(s).div(e.mul(2)).mul(s).div(2*i/100),n=s.mul(100).div(i).add(e),u=s,a=0;a<256&&(r=u,!(u=u.mul(u).add(o).div(u.mul(2).add(n).sub(s))).sub(r).abs().lte(1));a++);return u}var R=function(t){function e(){return t.apply(this,arguments)||this}return r(e,t),e}(u(Error));function C(t,e,r){void 0===r&&(r=!0);var s=parseInt(t.reserve0.toString()),i=parseInt(t.reserve1.toString()),o=r?1-t.fee:1;switch(t.type){case exports.PoolType.ConstantProduct:var n=s/o;return i*n/(n+e)/(n+e);case exports.PoolType.Weighted:var u=t.weight0/t.weight1,a=s+e*o;return i*u*o*Math.pow(s/a,u)/a;case exports.PoolType.Hybrid:var c=t,h=parseInt(T(c).toString()),p=c.A/100,v=s+e,l=4*p*v+h-4*p*h,d=h*h*h/v;return(.5-(2*l-d/v)/Math.sqrt(l*l+4*p*d)/4)*o}return 0}exports.ASSERT=function(t,e){},exports.CLRPool=m,exports.CL_MAX_TICK=887271,exports.CL_MIN_TICK=-887272,exports.ConstantProductRPool=f,exports.DEBUG=c,exports.DEBUG_MODE_ON=function(t){a=t},exports.Edge=b,exports.Graph=S,exports.HybridComputeLiquidity=T,exports.HybridRPool=g,exports.HybridgetY=M,exports.OutOfLiquidity=R,exports.Pool=O,exports.RConcentratedLiquidityPool=w,exports.RConstantProductPool=x,exports.RHybridPool=E,exports.RPool=d,exports.RWeightedPool=N,exports.StableSwapRPool=I,exports.TYPICAL_MINIMAL_LIQUIDITY=1e3,exports.TYPICAL_SWAP_GAS_COST=6e4,exports.Vertice=y,exports.calcInByOut=function(e,r,s){var i=0,o=s?e.reserve0:e.reserve1,n=s?e.reserve1:e.reserve0;switch(e.type){case exports.PoolType.ConstantProduct:var u=parseInt(o.toString()),a=parseInt(n.toString());i=u*r/(1-e.fee)/(a-r);break;case exports.PoolType.Weighted:var c=parseInt(o.toString()),h=parseInt(n.toString());i=c*(1-e.fee)*(Math.pow(1-r/h,-(s?e.weight0/e.weight1:e.weight1/e.weight0))-1);break;case exports.PoolType.Hybrid:var p=n.sub(v(r));p.lt(1)&&(p=t.BigNumber.from(1));var l=M(e,p);i=Math.round(parseInt(l.sub(o).toString())/(1-e.fee));break;default:console.error("Unknown pool type")}return i<1&&(i=1),i},exports.calcInputByPrice=function(t,e,r){switch(void 0===r&&(r=1),t.type){case exports.PoolType.ConstantProduct:var s=parseInt(t.reserve0.toString()),i=parseInt(t.reserve1.toString()),o=s/(1-t.fee);return Math.sqrt(i*o*e)-o;case exports.PoolType.Weighted:return function(t,e){var r=parseInt(t.reserve0.toString()),s=parseInt(t.reserve1.toString()),i=t.weight0/t.weight1,o=s*e*i*(1-t.fee)*Math.pow(r,i);return(Math.pow(o,1/(i+1))-r)/(1-t.fee)}(t,e);case exports.PoolType.Hybrid:return p((function(e){return 1/C(t,e)}),e,r)}return 0},exports.calcOutByIn=function(t,e,r){void 0===r&&(r=!0);var s=r?t.reserve0:t.reserve1,i=r?t.reserve1:t.reserve0;switch(t.type){case exports.PoolType.ConstantProduct:var o=parseInt(s.toString());return parseInt(i.toString())*e/(o/(1-t.fee)+e);case exports.PoolType.Weighted:var n=parseInt(s.toString());return parseInt(i.toString())*(1-Math.pow(n/(n+e*(1-t.fee)),r?t.weight0/t.weight1:t.weight1/t.weight0));case exports.PoolType.Hybrid:var u=M(t,s.add(v(e*(1-t.fee))));return parseInt(i.sub(u).toString())}return-1},exports.calcPrice=C,exports.calcSquareEquation=function(t,e,r){var s=e*e-4*t*r;console.assert(s>=0,"Discriminant is negative! "+t+" "+e+" "+r);var i=Math.sqrt(s);return[(-e-i)/2/t,(-e+i)/2/t]},exports.calcTokenPrices=function(t,e){var r=new S(t,e,0),s=new Map;return r.vertices.forEach((function(t){return s.set(t.token,t.price)})),s},exports.closeValues=h,exports.findMultiRouteExactIn=function(e,r,s,i,o,n,u){s instanceof t.BigNumber&&(s=parseInt(s.toString()));var a=new S(i,o,n),c=a.tokens.get(e.address);if(0===(null==c?void 0:c.price)&&a.setPricesStable(c,1,0),void 0!==u)return a.findBestRouteExactIn(e,r,s,u);var h=a.findBestRouteExactIn(e,r,s,1);a.cleanTmpData();var p,v,l=k(h,s,null==c?void 0:c.gasPrice);return 1===l?h:(v=a.findBestRouteExactIn(e,r,s,l),(p=h).status==exports.RouteStatus.NoWay?v:v.status==exports.RouteStatus.NoWay?p:p.status==exports.RouteStatus.Partial&&v.status==exports.RouteStatus.Success?v:v.status==exports.RouteStatus.Partial&&p.status==exports.RouteStatus.Success||p.totalAmountOut>v.totalAmountOut?p:v)},exports.findMultiRouteExactOut=function(e,r,s,i,o,n,u){s instanceof t.BigNumber&&(s=parseInt(s.toString()));var a=new S(i,o,n),c=a.tokens.get(e.address);if(0===(null==c?void 0:c.price)&&a.setPricesStable(c,1,0),void 0!==u)return a.findBestRouteExactOut(e,r,s,u);var h=a.findBestRouteExactOut(e,r,s,1);a.cleanTmpData();var p=k(h,h.amountIn,null==c?void 0:c.gasPrice);return 1===p?h:function(t,e,r){return t.status==exports.RouteStatus.NoWay?e:e.status==exports.RouteStatus.NoWay?t:t.status==exports.RouteStatus.Partial&&e.status==exports.RouteStatus.Success?e:e.status==exports.RouteStatus.Partial&&t.status==exports.RouteStatus.Success||t.amountIn+t.gasSpent*r<e.amountIn+e.gasSpent*r?t:e}(h,a.findBestRouteExactOut(e,r,s,p),n)},exports.findSingleRouteExactIn=function(e,r,s,i,o,n){var u=new S(i,o,n),a=u.tokens.get(e.address);return 0===(null==a?void 0:a.price)&&u.setPricesStable(a,1,0),s instanceof t.BigNumber&&(s=parseInt(s.toString())),u.findBestRouteExactIn(e,r,s,1)},exports.findSingleRouteExactOut=function(e,r,s,i,o,n){var u=new S(i,o,n),a=u.tokens.get(e.address);return 0===(null==a?void 0:a.price)&&u.setPricesStable(a,1,0),s instanceof t.BigNumber&&(s=parseInt(s.toString())),u.findBestRouteExactOut(e,r,s,1)},exports.getBigNumber=v,exports.revertPositive=p;
//# sourceMappingURL=teleswap-tines-sdk.cjs.production.min.js.map
